# 03_3D空間剛體運動
###### tags: `SLAM`
[TOC]
## 主要目標:
1. 3D空間剛體運動
    - [x] 旋轉矩陣
    - [x] 轉換矩陣
    - [ ] 四元數
    - [ ] 尤拉角
2. Eigen
    - [x] 矩陣
    - [ ] 幾何模組

# 3.1 旋轉矩陣
## 3.1.1 點、向量和座標系
- 幾個名詞的表述:
    - 基底
    - 座標向量
    - 內積
    - 外積
    - 反對稱矩陣
## 3.1.2 座標系間的歐式轉換
- 旋轉矩陣:
    - 假設有兩組==正交==基底ei、ei'
    - 假設向量a在兩組基底下有座標ai、ai'
    - 則ei * ai = e'i * ai'
    - 同乘ei，得到ai = R * a'
    - 這個R就是旋轉矩陣
- SO(n)的介紹(特殊正交群):
    - SO(n) = {R|RR^T=I, det(R)=1}
- 旋轉矩陣的性質:
    - 反矩陣描述了相反的旋轉
- 描述一個歐式轉換:
    - a' = Ra + t
    - $a_1 = R_{12}a_2+t_{12}$
- 平移向量:
    - t_12: 座標系1原點指向座標系2原點的向量，在座標系1下取的座標。
- 想清楚
    - [x] $R12$和$R21$互為反矩陣，但$t_{21}$不是$t_{12}$取負號
## 3.1.3 轉換矩陣與齊次座標
- 轉換矩陣T描述了歐式轉換(平移+旋轉)
    - 使用齊次座標來轉換
    - 維度是3x3的旋轉矩陣R描述歐式轉換:
        - $a_1 = R_{12}a_2+t_{12}$
    - 維度是4x4的轉換矩陣T描述歐是轉換:
        - $a_1 = Ta_2$
        - 這邊$a_1$和$a_2$都是$\in R^4$，在尾端補1
        - T是R右邊補t下面補1
- 特殊歐式群的定義
    - SE(3)
- 附帶的性質
    - T的反矩陣是反轉換，可以從這邊推得$t_{12}$和$t_{21}$的關係
- [ ] c++中使用運算子多載完成齊次座標和非齊次座標的轉換
# 3.2 實作: Eigen
- 安裝:
    - `sudo apt install libeigen3-dev`
- [eigenTUT](http://eigen.tuxfamily.org/dox-devel/modules.html)
- Cmake:
    - set
    - include_directories
        - 添加Eigen頭文件
- 基本使用: eigenMatrix
    - 基本矩陣的宣告
        - ``Matrix<float, 2, 3> matrix_23;``
        - 初始化零矩陣:
            - ``Matrix3d matrix_33 = Matrix3d::Zero();`` 
        - eigen通過typedef提供許多內置類型
            - Vector3d
            - Matrix3d
        - 有動態矩陣大小
            - ``Matrix<double, Dynamic, Dynamic> matrix_dynamic;
            - ``MatrixXd matrix_x;``
        - 隨機初始化矩陣
            - ``Matrix3d::Random();``
    - 操作:
        - 可以直接cout
        - 用``<<``初始化
        - 用index訪問 matrix_33(1, 1)
    - 相乘:
        - 注意: 不能混合不同類型的矩陣
        - 要顯示轉換``matrix.cast``
    - 基本矩陣操作:
        - .transpose()
        - .sum()
        - .trace()
        - .inverse()
        - .determinant()
    - EigenSolver
        - 解eigen vector和eigen value
        ```
        SelfAdjointEigenSolver<Matrix3d> eigen_solver(matrix_33.transpose() * matrix_33);
        eigen_solver.eigenvalues()
        eigen_solver.eigenvectors()
        ```
    - 解方程式
        - [ ] 直接用逆矩陣
        - [ ] 用QR分解
        - [ ] 用cholesky分解
    - [x] c\+\+的計時
# 3.3 旋轉向量和尤拉角
## 3.3.1 旋轉向量
- 描述: 
    - 三維空間3*3旋轉矩陣描述了6自由度的轉換(旋轉+平移)
    - 旋轉矩陣保證行列式=1且正交不好優化
    - 尋求更好的表示(緊湊)
- 旋轉向量
    - 方向等於旋轉軸
    - 長度等於旋轉角
    - 假設旋轉軸$n$為單位長度旋轉方向向量$\theta$為旋轉角，則$\theta n$就是旋轉向量
- 旋轉向量與旋轉矩陣
    - Rodrigues's Formula
        - $R = cos\theta I+(1-cos \theta)nn^T+sin\theta$ n
        - (==這個n是把向量n轉成反對稱矩陣==)
        - [維基](https://en.wikipedia.org/wiki/Rodrigues%27_rotation_formula)
    - 因此由旋轉向量求旋轉矩陣顯然
    - 兩邊求trace和簡單代數可以得到由R求$\theta$和$n$
    - $n$就是R特徵值1對應的特徵向量
## 3.3.2 尤拉角
- 旋轉向量不直觀
- 尤拉角:
    - 以[roll, pitch, yaw]描述旋轉
    - 定義沒統一
        - 通常指(偏航->俯仰->滾轉)
    - [ ] 萬象鎖問題
        - 導致損失一個自由度
        - ==只要想用3個實數表達3D旋轉，都會有萬向鎖問題(?)==(這包含旋轉向量)

    - 通常僅在人機互動使用
# 3.4 四元數
## 3.4.1 四元數的定義
- [ ] 乘上負數i相當於逆時鐘把複向量旋轉90
- [ ] 由拉公式
- [ ] 由一個實數和一個向量定義四元數
## 3.4.2 四元數的運算
- 四則
    - 乘法不可交換
- norm
    - 2norm
- 共軛
    - 把虛部取成相反數
        - 性質: 共扼相乘是norm平方
- 逆
    - 相乘等於1定義逆
        - 性質: 逆就是共扼分之一
        - 性質2: $(q_aq_b)^{-1}=q_b^{-1}q_a^{-1}$
- 數乘
    - 常數各分量乘
## 3.4.3 用四元數表示旋轉
- 三維空間點p經過旋轉得p'=Rp
- 把p做成實部為零的四元數，就是點在四元數的表示
    - 這個相當於把四元數的虛部跟三維空間對應

- $p' = qpq^{-1}$
- 實部必為零
## 3.4.4 四元數到其他旋轉表示的轉換
- [ ] 推一下
# 3.5 \*相似、仿射、射影轉換
- 真實世界到相機照片可以看成是射影轉換
    - 相機焦距無窮遠則是仿射轉換
- [ ] 自由度查一下
# 3.6 實作: Eigen幾何模組
## 3.6.1 Eigen幾何模組的資料示範
- [x] 旋轉矩陣、歐拉角的宣告、轉換
## 3.6.2 實際的座標轉換實例
- [x] 世界座標的轉換
# 3.7 視覺化示範

## 3.7.1 顯示運動軌跡
- [x] 讀取、畫出運動軌跡
- [ ] pangolin
    - [ ] opengl
    - [ ] glew
## 3.7.2 顯示相機的位姿
- [x] 實際顯示3d的四元數、歐拉角等等轉換
# 3.8 習題
- [ ] 1. 驗證旋轉矩陣是正交矩陣
- [ ] 2. 尋找羅德里格斯公式的推倒並加以了解
- [ ] 3. 驗證四元數旋轉某個點後，結果是一個虛四元數，所以仍然對應到一個3D空間點
- [ ] 4. 畫表歸納旋轉矩陣、軸角、尤拉角、四元數的轉換關係
- [ ] 5. 假設有一個大的Eigen矩陣，想把它的左上角3x3區塊取出來，然後設定值為$I_{3x3}$。請程式設計實現
- [ ] 6. 一般線性方程式$Ax=b$有哪幾種做法?你能在Eigen中實現嗎
# 線代筆記
- 旋轉矩陣的性質:
    - 行列式為1的正交矩陣就是一個旋轉矩陣
    - 正交矩陣的反矩陣就是轉置矩陣
- 對角化:
    - 保證對角化的性質